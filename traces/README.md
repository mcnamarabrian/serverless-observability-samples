# traces

You can use [AWS X-Ray](https://aws.amazon.com/xray/) to analyze and debug production, distributed applications, such as those built using a microservices architecture. With X-Ray, you can understand how your application and its underlying services are performing to identify and troubleshoot the root cause of performance issues and errors. X-Ray provides an end-to-end view of requests as they travel through your application, and shows a map of your applicationâ€™s underlying components. You can use X-Ray to analyze both applications in development and in production, from simple three-tier applications to complex microservices applications consisting of thousands of services.

**Note** Your resource needs proper IAM permissions to create traces.


# Deploying sample application

A sample serverless application has been defined in (template.yml)[./template.yml].  This application is a Python function that returns a JSON payload of a lottery winner, the amount won, and indicates whether the winner is, in fact, a big winner (>= 80).

The first step is to *build* the application including any dependencies.

```bash
sam build --use-container
```

Once the application has been bundled, it can be deployed by using the following command:

```bash
sam deploy --guided
```

# Invoking the function

Once the application has been deployed, it can be tested with an empty payload.  

```bash
export STACK_NAME=whatever_you_specified_during_guided_deploy
export FUNCTION=$(aws cloudformation describe-stack-resource --stack-name ${STACK_NAME} --logical-resource-id RandomBigWinnerTracedFunction --query "StackResourceDetail.PhysicalResourceId" --output text)
aws lambda invoke \
    --function-name ${FUNCTION} \
    --payload '{ }' \
    response.json
```

The return value is stored in the file `response.json`.  This can be repeated any number of times to generate a function invocation.

Investigate the traces and annotations generated by invoking your function via the X-Ray Console.

Find out who your big winners are by entering the following into the Search Bar:

```bash
annotation.BIG_WINNER = "YES"
```

and 

```bash
annotation.BIG_WINNER = "YES"
```

# Cleaning up

Once you are done using the stack, its resources can be removed.

```bash
aws cloudformation delete-stack \
--stack-name ${STACK_NAME}
```